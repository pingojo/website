name: Test Website Field

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  test-website-field:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout Code
        uses: actions/checkout@v3

      # Set up Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # Install @supabase/supabase-js dependency
      - name: Install Dependencies
        run: npm install @supabase/supabase-js

      # Run the test script
      - name: Run Website Field Test
        run: |
          # Create a simple test script with graceful quota handling
          cat > test-website-field.js << 'EOF'
          const { createClient } = require('@supabase/supabase-js');

          (async () => {
            const supabaseUrl = process.env.SUPABASE_URL || 'https://eyghpgfznmuahcqohmkk.supabase.co';
            const supabaseKey = process.env.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Z2hwZ2Z6bm11YWhjcW9obWtrIiwicm9sZSI6ImFub24iLCJpYXQiOjE2OTM5NTY4MDMsImV4cCI6MjAwOTUzMjgwM30.j_5poF_GPEZ6RoMwNjz1ndxaaw6CdGDFLuVVbJR_MAs';
            const supabase = createClient(supabaseUrl, supabaseKey);
            try {
              const { data, error } = await supabase
                .from('company')
                .select('*')
                .limit(1)
                .single();

              if (error) throw error;

              console.log('Fetched data:', data);

              if ('website' in data) {
                throw new Error('Error: The "website" field exists in the data.');
              }

              console.log('Test Passed: No "website" field found.');
              process.exit(0);
            } catch (err) {
              const msg = (err && err.message) ? err.message : String(err);
              if (msg.includes('exceed_egress_quota') || msg.includes('Service for this project is restricted')) {
                console.warn('Skipping test due to Supabase quota restriction:', msg);
                process.exit(0);
              } else {
                console.error('Failed to fetch data:', msg);
                process.exit(1);
              }
            }
          })();
          EOF

          # Run the test
          node test-website-field.js